# Human Journal
Последнее обновление: YYYY-MM-DD HH:MM TZ


## Хронология работ
(этапы, зачем/польза, маркеры RCC)


## Что готово (MVP) / Что блокирует (Prod)


## Частые ошибки (объяснение)


Последнее обновление: 2025‑09‑25 10:00 America/Chicago
Назначение: единый «источник правды» по проектам Ася и Motospark: человеческое описание (подробно), техническая шпаргалка (кратко), принятые решения (ADR), частые ошибки, аннотации к файлам/папкам, регламенты обновления и Git‑процессы.

Маркеры ссылок на историю: [RCC-<Дата>-<№>] соответствуют «Recent Conversation Content» (список диалогов с датами и пунктами в истории чатов). Примеры: [RCC-2025-09-16-7] → пункт 7 от 2025‑09‑16 («Excel‑ingest сервис код»); [RCC-2025-09-18-5] → пункт 5 от 2025‑09‑18 и т.д.

Часть A — Human Journal (human.md)

Подробное описание «для человека»: что делали, зачем, как влияет на архитектуру и пользу для проекта. Здесь — углублённая версия с мотивами, поворотными решениями и ошибками.

1) Хронология ключевых решений и работ (детально)

Этап 0. Зарождение (Motospark, Docker Compose)

Подняли локальные сервисы: Redis, MinIO, Qdrant через infra/docker/docker-compose.yml.
Зачем: получить рабочее окружение «на одном ПК» без Kubernetes.
Польза: быстрая разработка и отладка интеграций (хранилище файлов MinIO, кэш Redis, векторная БД Qdrant для будущих AI‑фич).
Проблемы: ошибки зависимостей Node/TS (пример: bcryptjs без типов).
Вывод: зафиксировать версии зависимостей, подключить типы, добавить сборку и линт в CI.
Маркер: [RCC-2025-09-01-22], [RCC-2025-09-04-18/19].

Этап 1. Переход к Kubernetes (Docker Desktop K8s)

Включили кластер K8s в Docker Desktop, установили ingress‑nginx и cert‑manager (self‑signed для dev).
Почему так: хотим единый ingress‑слой (*.dev.asia.local) и TLS‑цепочки даже в dev → привычка к прод‑режиму.
Проблемы: генерация локальных сертификатов, конфигурация Dashboard.
Маркер: [RCC-2025-09-11-10], [RCC-2025-09-10-11].

Развернули Zalando Postgres Operator → Patroni/Spilo‑14 кластер, PgBouncer (pooler), HAProxy. Порты: 5432/5433; HAProxy 5000/7000.
Почему так: сразу тренируемся на отказоустойчивой схеме и единой точке входа (PgBouncer), чтобы сервисы не «знали» про лидера БД.
Проблемы: сложность YAML/patch, необходимость аккуратно передавать секреты (оператор генерит, нужно правильно маппить в env).
Маркер: [MSC-5], [MSC-2], [MSC-4].

Оформили ExternalName для MinIO и Redis (minio-dev, redis-dev → host.docker.internal).
Почему так: быстро подключаем локальные сервисы без развёртывания их в кластере.
Компромисс: меньше похожести на прод; но быстро.
Маркер: [MSC-2].

Этап 2. Сервисы уровня MVP

excel‑ingest (FastAPI выбран как предпочтение).
Почему так: Python богаче экосистемой для Excel/CSV и нормализации данных; FastAPI даёт быстрый REST и типизацию.
Задача: принимать файлы (разные структуры), нормализовать артикулы (транслит, приведение к normalized_key = brand:number), складывать оригинал/результаты в MinIO (uploads/{org_id}/…, results/{org_id}/…), писать строки в Postgres через PgBouncer/TLS и слать события в n8n.
Проблемы: ImagePullBackOff (нет образа в GHCR), временный переход на busybox‑контейнер; сложности с kubectl patch для снятия command.
Решение: оформить Dockerfile, CI в GHCR, readiness/liveness, секреты от Zalando, чёткие env (DB_*, PGSSLMODE=require).
Маркер: [MSC-3], [MSC-7], [RCC-2025-09-16-7], [RCC-2025-09-23-2].

n8n в queue‑mode (main+worker+Redis).
Почему так: устойчивость к тяжёлым задачам и возможность HITL (человек в контуре).
Поворотное решение: отказаться от попытки «всё собрать в одном сервисе/коде» и использовать оркестратор.
Проблемы: 404 на prod‑webhook («not registered») при неактивном workflow; путаница с test vs prod URL.
Решение: всегда активировать воркфлоу перед prod‑вызовами; завести runbook «Webhook n8n».
Маркер: [RCC-2025-09-18-5], [RCC-2025-09-10-13], [RCC-2025-09-15-16].

Appsmith как UI.
Почему так: быстро получить управляемые панели и не писать фронт с нуля; подходит для внутренних операторов.
Проблемы: потеря состояния после рестартов (не настроены volumes), настройка APPSMITH_ALLOWED_HOSTS.
Решение: добавить персистентность; оформить runbook по установке/обновлению/бэкапу.
Маркер: [RCC-2025-09-18-4], [RCC-2025-09-09-14].

Этап 3. Диагностика и эксплуатационные практики

Сетевые проверки (netstat 9000/6379), curl‑pods, rollout restart/status, health‑эндпоинты.
Почему так: быстрые инструменты для локализации проблем.
Ошибки: неверные флаги в kubectl run (--requests), кавычки в PowerShell, -X не работает в Invoke-WebRequest.
Решение: стандартизировать диагностические команды, добавить готовые однострочники.
Маркер: [RCC-2025-09-22-3], [RCC-2025-09-22-1], [RCC-2025-09-15-8].

Этап 4. Фокусировка на MVP (отсечение)

Отложили GitOps/Helm/ArgoCD, VoiceFlow, Zapier.
Почему так: каждое направление тянет время; MVP = ingest + n8n + PG/MinIO + базовый UI.
Польза: меньше переключений, быстрее до пользы (кроссы, КП, e‑mail/WhatsApp).
Маркер: [RCC-2025-09-20-21], [RCC-2025-09-05-17].

Этап 5. Бизнес‑логика и ИИ‑роль «Аси»

Таблицы: companies, contacts, contact_emails, messages, parts, crosses, stocks, quotes, quote_items, integrations_state, kb_answers, brand_prefs и др.
Почему так: нам нужна нормализованная сущностная модель для кросс‑поиска и формирования КП; normalized_key = brand:number как индекс для быстрых совпадений.
HITL‑петли: если Асe не хватает данных — эскалация оператору либо «подсказка с обучением», чтобы в следующий раз брать из kb_answers.
Каналы: WhatsApp API и Яндекс.Почта (IMAP/SMTP) — как целевой план.
Маркер: [MSC-1], [MSC-3], [MSC-4], [MSC-9].

2) Что уже готово к моменту MVP (уточнённо)

K8s dev‑кластер: ingress‑nginx, cert‑manager (self‑signed), Dashboard.

Postgres (Patroni/Spilo‑14) + PgBouncer + HAProxy; доступ из кластера.

Redis/MinIO доступны через ExternalName.

n8n в queue‑mode, вебхуки доходят при активных воркфлоу; были успешные executions.

Appsmith развёрнут (нуждается в персистентности).

excel‑ingest: деплой есть; код в процессе/частично; нужен образ в GHCR, probes и wiring секретов.

Сформирована целевая бизнес‑логика (таблицы/потоки), есть план HITL и ABCP/1С интеграций.

3) Что блокирует продакшен (расширено)

Нет GHCR CI/CD для excel‑ingest (и для других сервисов).

Нет Helm‑чартов/values и GitOps (ArgoCD).

Персистентность n8n/Appsmith по умолчанию не настроена.

Часть решений не оформлена ADR (значит, мы рискуем повторять обсуждения).

Не закрыт набор runbooks на операции (деплой/откат/секреты/диагностика).

4) Частые ошибки и как их избегать (расширено)

PowerShell curl: curl → это alias на Invoke-WebRequest; -X не работает.
Рецепт: curl.exe (явный бинарь) или Invoke-WebRequest -Method Post .... [RCC-2025-09-22-1]

kubectl run флаги ресурсов: --requests не поддерживается так, как в docker; используем манифест или --overrides. [RCC-2025-09-22-3]

kubectl patch кавычки: JSON в PowerShell ломается из‑за кавычек/бэктиков.
Рецепт: --patch-file patch.json или here‑string; либо kubectl edit. [RCC-2025-09-16-9]

n8n «чистый лист» после рестартов: забытые volumes.
Рецепт: PVC/hostPath; зафиксировать в манифестах. [RCC-2025-09-09-14]

Повторные патчи excel‑ingest: отсутствие журнала.
Рецепт: /scratch с датой+комментарием и ссылка на коммит/ADR. [RCC-2025-09-16-9]

Смешение dev/prod логики: попытки «как в прод» на dev‑ExternalName.
Рецепт: явно разделять k8s/dev и будущий k8s/prod, фиксировать отличия в docs/tech.md.

5) Аннотации к файлам/папкам (расширено)

infra/docker/docker-compose.yml — локальные Redis/MinIO/Qdrant (dev). [RCC-2025-09-01-22], [RCC-2025-09-04-19]

k8s/base/namespaces.yaml — базовые неймспейсы (asia-dev, позже asia-prod). [MSC-6]

k8s/dev/* — манифесты dev (deploy/svc/ingress/CM/Secrets). [RCC-2025-09-11-11]

k8s/dev/n8n/* — main/worker/redis/ingress; PVC для персистентности (добавить). [RCC-2025-09-18-5]

k8s/dev/excel-ingest/* — деплой/сервис/probes; секреты PG (из Zalando), MinIO creds. [RCC-2025-09-16-7]

apps/excel-ingest/* — FastAPI, Dockerfile, requirements; обработка Excel/CSV, MinIO SDK, PG через psycopg. [MSC-3], [RCC-2025-09-23-2]

apps/auth-service/* — проблемы с bcryptjs (нужны типы/замена). [RCC-2025-09-04-18]

tools/minio/* — диагностика MinIO; curl‑pods, политики ведёрок. [RCC-2025-09-16-7]

/home/aas/dashboard-local.{crt,key} — самоподписанный TLS для Dashboard. [RCC-2025-09-11-10]

При добавлении новых файлов — обновлять /docs/FILES.md с краткой аннотацией «зачем/польза/ссылка на ADR».

6) Регламент обновления и как не терять изменения (детально)

Weekly‑ритуал: /status/weekly-YYYY-MM-DD.md (Done/Blockers/Next).

ADR при каждом значимом решении: /adr/ADR-XXXX-*.md с Context/Decision/Consequences/References.

Runbooks: все повторяемые операции фиксируются в /runbooks/*.md.

Tech/Human: обновлять «инвентарь» и «зачем/польза» при каждом изменении сервисов.

Таймстемпы: в шапке каждого файла «Последнее обновление: …» + дата в имени status/scratch.

Коммиты: префикс docs: / adr: / runbook: / status: и краткая причина.

Часть B — Tech Index (tech.md)